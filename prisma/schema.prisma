generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                String             @id @default(cuid())
  username          String             @unique
  email             String             @unique
  password          String             // Hashed password
  fullName          String
  avatar            String?
  bio               String?
  location          Region?
  website           String?
  phone             String?
  joinedAt          DateTime           @default(now())
  reputation        Int                @default(0)
  isVerified        Boolean            @default(true)
  isActive          Boolean            @default(true)
  role              UserRole?
  lastActive        DateTime           @default(now())
  postsCount        Int                @default(0)
  commentsCount     Int                @default(0)
  projectsCount     Int                @default(0)
  eventsCount       Int                @default(0)
  servicesCount     Int                @default(0)
  opportunitiesCount Int                @default(0)
  pilotLicense      String?
  organization      String?
  experience        String?
  specializations   Json?
  certifications    Json?
  opportunities     Opportunity[]
  applications      JobApplication[]
  rsvps             rsvp[]
  resources         Resource[]
  commentLikes      CommentLike[]
  projectComments   Comment[]
  events            Event[]
  forumCommentLikes ForumCommentLike[]
  comments          ForumComment[]
  forumPostLikes    ForumPostLike[]
  posts             ForumPost[]
  projectLikes      ProjectLike[]
  projects          Project[]
  services          Service[]
  createdForms      ApplicationForm[]        // Forms created by this user
  formSubmissions   ApplicationSubmission[]  // Applications submitted by this user
  savedOpportunities SavedOpportunity[]     // Opportunities saved by this user
  universalForms    UniversalForm[]         // Universal forms created by this user
  formEntries       FormEntry[]             // Form entries submitted by this user
  // Approval relations
  approvedForumPosts   ForumPost[]    @relation("ForumPostApprover")
  approvedProjects     Project[]      @relation("ProjectApprover")
  approvedEvents       Event[]        @relation("EventApprover")
  approvedResources    Resource[]     @relation("ResourceApprover")
  approvedOpportunities Opportunity[] @relation("OpportunityApprover")

  @@map("users")
}

model ForumCategory {
  id          String      @id @default(cuid())
  name        String
  description String
  slug        String      @unique
  color       String
  postCount   Int         @default(0)
  lastPostAt  DateTime?
  posts       ForumPost[]

  @@map("forum_categories")
}

model ForumPost {
  id           String          @id @default(cuid())
  title        String
  content      String
  categoryId   String
  authorId     String
  tags         Json?
  createdAt    DateTime        @default(now())
  updatedAt    DateTime        @updatedAt
  viewsCount   Int             @default(0)
  repliesCount Int             @default(0)
  likesCount   Int             @default(0)
  lastReplyAt  DateTime?
  isPinned     Boolean         @default(false)
  isLocked     Boolean         @default(false)
  isApproved   Boolean         @default(false)
  approvedAt   DateTime?
  approvedBy   String?
  approvedByUser User?         @relation("ForumPostApprover", fields: [approvedBy], references: [id])
  comments     ForumComment[]
  likes        ForumPostLike[]
  author       User            @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category     ForumCategory   @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@map("forum_posts")
}

model ForumComment {
  id         String             @id @default(cuid())
  content    String
  postId     String
  authorId   String
  parentId   String?
  createdAt  DateTime           @default(now())
  updatedAt  DateTime           @updatedAt
  likesCount Int                @default(0)
  isEdited   Boolean            @default(false)
  likes      ForumCommentLike[]
  author     User               @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent     ForumComment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    ForumComment[]     @relation("CommentReplies")
  post       ForumPost          @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@map("forum_comments")
}

model ProjectCategory {
  id          String    @id @default(cuid())
  name        String
  description String
  slug        String    @unique
  icon        String    @default("üöÅ")
  color       String    @default("#3B82F6")
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  projects    Project[]

  @@map("project_categories")
}

model Project {
  id              String           @id @default(cuid())
  title           String
  description     String
  fullDescription String?
  categoryId      String?
  status          ProjectStatus
  authorId        String
  location        String?
  duration        String?
  startDate       String?
  endDate         String?
  funding         String?
  technologies    Json?
  objectives      Json?
  challenges      Json?
  outcomes        Json?
  methodology     String?
  results         String?
  teamMembers     Json?
  gallery         Json?
  resources       Json?
  thumbnail       String?
  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  viewsCount      Int              @default(0)
  likesCount      Int              @default(0)
  isFeatured      Boolean          @default(false)
  isApproved      Boolean          @default(false)
  approvedAt      DateTime?
  approvedBy      String?
  approvedByUser  User?            @relation("ProjectApprover", fields: [approvedBy], references: [id])
  comments        Comment[]
  likes           ProjectLike[]
  author          User             @relation(fields: [authorId], references: [id], onDelete: Cascade)
  category        ProjectCategory? @relation(fields: [categoryId], references: [id])

  @@map("projects")
}

model Comment {
  id         String        @id @default(cuid())
  content    String
  projectId  String
  authorId   String
  parentId   String?
  createdAt  DateTime      @default(now())
  updatedAt  DateTime      @updatedAt
  likesCount Int           @default(0)
  likes      CommentLike[]
  author     User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  parent     Comment?      @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies    Comment[]     @relation("CommentReplies")
  project    Project       @relation(fields: [projectId], references: [id], onDelete: Cascade)

  @@map("comments")
}

model CommentLike {
  id        String   @id @default(cuid())
  userId    String
  commentId String
  createdAt DateTime @default(now())
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@map("comment_likes")
}

model ProjectLike {
  id        String   @id @default(cuid())
  userId    String
  projectId String
  createdAt DateTime @default(now())
  project   Project  @relation(fields: [projectId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, projectId])
  @@map("project_likes")
}

model ForumPostLike {
  id        String    @id @default(cuid())
  userId    String
  postId    String
  createdAt DateTime  @default(now())
  post      ForumPost @relation(fields: [postId], references: [id], onDelete: Cascade)
  user      User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, postId])
  @@map("forum_post_likes")
}

model ForumCommentLike {
  id        String       @id @default(cuid())
  userId    String
  commentId String
  createdAt DateTime     @default(now())
  comment   ForumComment @relation(fields: [commentId], references: [id], onDelete: Cascade)
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, commentId])
  @@map("forum_comment_likes")
}

model EventCategory {
  id          String   @id @default(cuid())
  name        String
  description String
  slug        String   @unique
  icon        String   @default("üéØ")
  color       String   @default("#3B82F6")
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  events      Event[]

  @@map("event_categories")
}

model OpportunityCategory {
  id          String        @id @default(cuid())
  name        String        @unique
  description String
  icon        String        @default("üíº")
  color       String        @default("#3B82F6")
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  opportunities Opportunity[]

  @@map("opportunity_categories")
}

model ResourceCategory {
  id          String      @id @default(cuid())
  name        String      @unique
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  resources   Resource[]

  @@map("resource_categories")
}

model ServiceCategory {
  id          String      @id @default(cuid())
  name        String      @unique
  description String?
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  services    Service[]

  @@map("service_categories")
}

model EmploymentType {
  id          String        @id @default(cuid())
  name        String        @unique
  description String
  category    String        // "job", "gig", or "other"
  icon        String        @default("üíº")
  color       String        @default("#3B82F6")
  isActive    Boolean       @default(true)
  order       Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  opportunities Opportunity[]

  @@map("employment_types")
}

model Event {
  id                   String         @id @default(cuid())
  title                String
  description          String
  fullDescription      String?
  categoryId           String?
  startDate            DateTime
  endDate              DateTime
  location             String
  venue                String?
  capacity             Int?
  price                Float          @default(0)
  currency             String         @default("USD")
  registrationDeadline DateTime?
  organizerId          String
  isPublic             Boolean        @default(true)
  allowRegistration    Boolean        @default(true)
  registrationFormId   String?        // Link to Tally form for registration
  createdAt            DateTime       @default(now())
  updatedAt            DateTime       @updatedAt
  viewsCount           Int            @default(0)
  registeredCount      Int            @default(0)
  isPublished          Boolean        @default(false)
  isFeatured           Boolean        @default(false)
  isApproved           Boolean        @default(false)
  approvedAt           DateTime?
  approvedBy           String?
  approvedByUser       User?          @relation("EventApprover", fields: [approvedBy], references: [id])
  requirements         Json?
  tags                 Json?
  speakers             Json?
  agenda               Json?
  gallery              Json?
  flyer                String?
  rsvps                rsvp[]
  category             EventCategory? @relation(fields: [categoryId], references: [id])
  organizer            User           @relation(fields: [organizerId], references: [id], onDelete: Cascade)
  registrationForm     UniversalForm? @relation(fields: [registrationFormId], references: [id])

  @@map("events")
}

model Service {
  id          String   @id @default(cuid())
  title       String
  description String
  categoryId  String
  category    ServiceCategory @relation(fields: [categoryId], references: [id])
  region      Region
  contact     String
  phone       String?
  email       String?
  website     String?
  services    Json?
  rating      Float    @default(0)
  reviewCount Int      @default(0)
  isApproved  Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  providerId  String
  provider    User     @relation(fields: [providerId], references: [id], onDelete: Cascade)

  @@map("services")
}

model Resource {
  id          String       @id @default(cuid())
  title       String
  description String?
  fileUrl     String
  fileType    String       // PDF, Video, Excel, Word, etc.
  fileSize    String?      // File size in MB, KB, etc. (calculated automatically)
  fileUpload  String?      // Original uploaded file name
  categoryId  String
  category    ResourceCategory @relation(fields: [categoryId], references: [id])
  isRegulation Boolean     @default(false) // Special flag for regulation resources
  downloads   Int          @default(0)
  views       Int          @default(0)
  uploadedAt  DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  isApproved  Boolean      @default(false)
  approvedAt  DateTime?
  approvedBy  String?
  approvedByUser User?     @relation("ResourceApprover", fields: [approvedBy], references: [id])
  userId      String
  uploadedBy  User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("resources")
}

model Opportunity {
  id               String           @id @default(cuid())
  title            String
  description      String
  company          String
  opportunityType  String
  employmentTypeId String?
  subType          String?
  categoryId       String?
  location         String
  salary           String?
  requirements     Json?
  isUrgent         Boolean          @default(false)
  isRemote         Boolean          @default(false)
  isActive         Boolean          @default(true)
  tabCategory      String           @default("job")
  allowApplication Boolean          @default(true)
  applicationFormId String?         // Link to UniversalForm for application
  applicationDeadline DateTime?     // Application deadline
  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  isApproved       Boolean          @default(false)
  approvedAt       DateTime?
  approvedBy       String?
  approvedByUser   User?            @relation("OpportunityApprover", fields: [approvedBy], references: [id])
  posterId         String
  poster           User             @relation(fields: [posterId], references: [id], onDelete: Cascade)
  category         OpportunityCategory? @relation(fields: [categoryId], references: [id])
  employmentType   EmploymentType?      @relation(fields: [employmentTypeId], references: [id])
  applications     JobApplication[]
  savedBy          SavedOpportunity[]
  applicationForm  ApplicationForm? // One-to-one relationship (legacy)
  registrationForm UniversalForm?   @relation(fields: [applicationFormId], references: [id])
}

model ApplicationForm {
  id            String                    @id @default(cuid())
  opportunityId String                    @unique
  creatorId     String                    // User who created the form
  title         String                    @default("Application Form")
  description   String?
  stages        Json?                     // Multi-stage form configuration
  isActive      Boolean                   @default(true)
  createdAt     DateTime                  @default(now())
  updatedAt     DateTime                  @updatedAt
  opportunity   Opportunity               @relation(fields: [opportunityId], references: [id], onDelete: Cascade)
  creator       User                      @relation(fields: [creatorId], references: [id], onDelete: Cascade)
  fields       ApplicationFormField[]
  submissions  ApplicationSubmission[]
}

model ApplicationFormField {
  id                String                    @id @default(cuid())
  formId            String
  label             String
  type              ApplicationFieldType
  placeholder       String?
  required          Boolean                   @default(false)
  options           Json?                    // For select, radio, checkbox fields
  validation        Json?                    // Validation rules
  order             Int                      // Field order in form
  conditions        ApplicationFieldCondition[] // Conditional logic
  createdAt         DateTime                 @default(now())
  updatedAt         DateTime                 @updatedAt
  form              ApplicationForm          @relation(fields: [formId], references: [id], onDelete: Cascade)
  submissions       ApplicationFieldSubmission[]
}

model ApplicationFieldCondition {
  id                String                    @id @default(cuid())
  fieldId           String
  targetFieldId     String                    // Field this condition affects
  operator          ConditionOperator         // equals, not_equals, contains, etc.
  value             String                    // Value to compare against
  action            ConditionAction           // show, hide, require, etc.
  createdAt         DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  field             ApplicationFormField      @relation(fields: [fieldId], references: [id], onDelete: Cascade)
}

model ApplicationSubmission {
  id                String                    @id @default(cuid())
  formId            String
  applicantId       String
  status            ApplicationStatus         @default(PENDING)
  submittedAt       DateTime                  @default(now())
  updatedAt         DateTime                  @updatedAt
  form              ApplicationForm          @relation(fields: [formId], references: [id], onDelete: Cascade)
  applicant         User                     @relation(fields: [applicantId], references: [id], onDelete: Cascade)
  fieldSubmissions  ApplicationFieldSubmission[]
}

model ApplicationFieldSubmission {
  id                String                    @id @default(cuid())
  submissionId      String
  fieldId           String
  value             String                    // Submitted value
  createdAt         DateTime                  @default(now())
  submission        ApplicationSubmission     @relation(fields: [submissionId], references: [id], onDelete: Cascade)
  field             ApplicationFormField      @relation(fields: [fieldId], references: [id], onDelete: Cascade)
}

model JobApplication {
  id            String      @id @default(cuid())
  opportunityId String
  applicantId   String
  message       String?
  createdAt     DateTime    @default(now())
  applicant     User        @relation(fields: [applicantId], references: [id])
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id])
}

model SavedOpportunity {
  id            String      @id @default(cuid())
  userId        String
  opportunityId String
  savedAt       DateTime    @default(now())
  user          User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  opportunity   Opportunity @relation(fields: [opportunityId], references: [id], onDelete: Cascade)

  @@unique([userId, opportunityId])
  @@map("saved_opportunities")
}

model rsvp {
  id        String   @id @default(cuid())
  userId    String
  eventId   String
  createdAt DateTime @default(now())
  event     Event    @relation(fields: [eventId], references: [id])
  user      User     @relation(fields: [userId], references: [id])

  @@map("rsvp")
}

enum UserRole {
  hobbyist
  admin
  pilot
  regulator
  student
  service_provider
}

enum ProjectStatus {
  planning
  in_progress
  completed
  on_hold
  cancelled
}

enum EventType {
  presentation
  workshop
  panel
  break
  networking
}

enum Region {
  KIGALI_NYARUGENGE
  KIGALI_KICUKIRO
  KIGALI_GASABO
  SOUTH_HUYE
  SOUTH_NYAMAGABE
  SOUTH_NYARUGURU
  SOUTH_MUHANGA
  SOUTH_KAMONYI
  SOUTH_GISAGARA
  SOUTH_NYANZA
  SOUTH_RUHANGO
  NORTH_MUSANZE
  NORTH_GICUMBI
  NORTH_RULINDO
  NORTH_BURERA
  NORTH_GAKENKE
  EAST_KAYONZA
  EAST_NGOMA
  EAST_KIREHE
  EAST_NYAGATARE
  EAST_BUGESERA
  EAST_RWAMAGANA
  EAST_GATSIBO
  WEST_RUBAVU
  WEST_RUSIZI
  WEST_NYAMASHEKE
  WEST_RUTSIRO
  WEST_KARONGI
  WEST_NGORORERO
  WEST_NYABIHU
  UNKNOWN
}

enum ApplicationFieldType {
  TEXT
  TEXTAREA
  EMAIL
  PHONE
  NUMBER
  SELECT
  RADIO
  CHECKBOX
  DATE
  FILE
  PARAGRAPH
}

enum ConditionOperator {
  EQUALS
  NOT_EQUALS
  CONTAINS
  NOT_CONTAINS
  GREATER_THAN
  LESS_THAN
  IS_EMPTY
  IS_NOT_EMPTY
}

enum ConditionAction {
  SHOW
  HIDE
  REQUIRE
  MAKE_OPTIONAL
  ENABLE
  DISABLE
}

enum ApplicationStatus {
  PENDING
  REVIEWING
  APPROVED
  REJECTED
  WITHDRAWN
}

// Removed conflicting enum ResourceCategory because a model with the same
// name exists above. Categories are modeled relationally via `ResourceCategory` model.

enum OpportunityMainType {
  JOB
  GIG
  OTHER
}

enum OpportunitySubType {
  FULL_TIME
  PART_TIME
  FREELANCE
  PROJECT
  INTERNSHIP
  TRAINING
}

// Universal Form Builder Models
model UniversalForm {
  id          String        @id @default(cuid())
  userId      String
  title       String
  slug        String        @unique
  description String?
  settings    Json?         // Form settings (theme, redirect, etc.)
  isActive    Boolean       @default(true)
  isPublic    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  user        User          @relation(fields: [userId], references: [id], onDelete: Cascade)
  sections    FormSection[]
  entries     FormEntry[]
  events      Event[]       // Forms used for event registration
  opportunities Opportunity[] // Forms used for opportunity applications

  @@map("universal_forms")
}

model FormSection {
  id          String        @id @default(cuid())
  formId      String
  title       String
  description String?
  order       Int           // Section order within form
  conditional Json?         // Conditional logic for showing/hiding section
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  form        UniversalForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  fields      FormField[]

  @@map("form_sections")
}

model FormField {
  id          String       @id @default(cuid())
  sectionId   String
  type        FormFieldType
  label       String
  name        String       // Unique within form
  placeholder String?
  options     Json?        // For select, radio, checkbox fields
  validation  Json?        // Validation rules (required, regex, min/max, etc.)
  order       Int          // Field order within section
  conditional Json?        // Conditional logic for showing/hiding field
  isActive    Boolean      @default(true)
  // Matrix field properties
  matrixRows    Json?      // Array of row labels
  matrixColumns Json?      // Array of column labels
  matrixType    String?    // 'single' or 'multiple'
  // Linear scale properties
  scaleStart    Int?       // Start value
  scaleEnd      Int?       // End value
  scaleStep     Int?       // Step value
  leftLabel     String?    // Left label
  centerLabel   String?    // Center label
  rightLabel    String?    // Right label
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  section     FormSection  @relation(fields: [sectionId], references: [id], onDelete: Cascade)
  values      FormValue[]

  @@map("form_fields")
}

model FormEntry {
  id        String      @id @default(cuid())
  formId    String
  userId    String?     // Optional - for logged in users
  ip        String?
  meta      Json?       // User agent, referrer, etc.
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  form      UniversalForm @relation(fields: [formId], references: [id], onDelete: Cascade)
  user      User?       @relation(fields: [userId], references: [id], onDelete: SetNull)
  values    FormValue[]

  @@map("form_entries")
}

model FormValue {
  id           String     @id @default(cuid())
  entryId      String
  fieldId      String
  value        String     // For files, store path + original name as JSON
  createdAt    DateTime   @default(now())
  updatedAt    DateTime   @updatedAt
  entry        FormEntry  @relation(fields: [entryId], references: [id], onDelete: Cascade)
  field        FormField  @relation(fields: [fieldId], references: [id], onDelete: Cascade)

  @@map("form_values")
}

enum FormFieldType {
  SHORT_TEXT
  LONG_TEXT
  MULTIPLE_CHOICE
  CHECKBOXES
  DROPDOWN
  NUMBER
  EMAIL
  PHONE
  URL
  FILE_UPLOAD
  DATE
  TIME
  LINEAR_SCALE
  MATRIX
  RATING
}
